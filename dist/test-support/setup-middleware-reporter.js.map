{"version":3,"file":"setup-middleware-reporter.js","sources":["../../src/test-support/setup-middleware-reporter.ts"],"sourcesContent":["import QUnit from 'qunit';\nimport {\n  currentRouteName,\n  currentURL,\n  getContext,\n  getTestMetadata,\n} from '@ember/test-helpers';\nimport { isDevelopingApp, macroCondition } from '@embroider/macros';\nimport { setCustomReporter } from './reporter.ts';\nimport { setEnableA11yAudit } from './should-force-audit.ts';\n\nimport type { AxeResults, Result } from 'axe-core';\n\nexport interface TestMetadata {\n  testName?: string;\n  setupTypes: string[];\n  usedHelpers: string[];\n  [key: string]: unknown;\n\n  readonly isRendering: boolean;\n  readonly isApplication: boolean;\n}\n\ninterface AxeTestResult {\n  moduleName: string;\n  testName: string;\n  testMetaData: TestMetadata;\n  urls: string[] | Set<string>;\n  routes: string[] | Set<string>;\n  helpers: string[];\n  stack: string;\n  violations: Result[];\n}\n\nexport const TEST_SUITE_RESULTS: AxeTestResult[] = [];\n\nlet currentTestResult: AxeTestResult | undefined = undefined;\nlet currentViolationsMap: Map<string, Result> | undefined = undefined;\nlet currentUrls: Set<string> | undefined;\nlet currentRouteNames: Set<string> | undefined;\n\n/**\n * Utility to retrieve the route name corresponding to the current test. Absorbs the emitted\n * assertion error if route name is `null`, resulting in an empty string return value.\n *\n * @param getFn Function to use to derive the route name.\n * @returns Route name or empty string.\n */\nexport function _getCurrentRouteName(getFn = currentRouteName): string {\n  let routeName = '';\n\n  try {\n    routeName = getFn();\n  } catch (error: unknown) {\n    if (\n      error instanceof Error &&\n      !/currentRouteName (\\w|\\s)+ string/.test(error.message)\n    ) {\n      throw error;\n    }\n  }\n\n  return routeName;\n}\n\n/**\n * A custom reporter that is invoked once per failed a11yAudit call. This can be called\n * multiple times per test, and the results are accumulated until testDone.\n *\n * @param axeResults The axe results for each a11yAudit.\n * @returns Early returns if no violations are found.\n */\nexport function middlewareReporter(axeResults: AxeResults) {\n  if (axeResults.violations.length === 0) {\n    return;\n  }\n\n  const context = getContext();\n\n  if (!currentTestResult) {\n    const { module, testName } = QUnit.config.current as {\n      module: { name: string };\n      testName: string;\n    };\n    if (!context) {\n      throw new Error(\n        'You tried to run ember-a11y-testing without calling one of the `setupTest` helpers from `@ember/test-helpers`. Please make sure your test setup calls `setupTest()`, `setupRenderingTest()`, or `setupApplicationTest()`!',\n      );\n    }\n    const testMetaData = getTestMetadata(context);\n\n    const stack = macroCondition(isDevelopingApp())\n      ? ''\n      : new Error().stack || '';\n\n    currentTestResult = {\n      moduleName: module.name,\n      testName,\n      testMetaData,\n      urls: [],\n      routes: [],\n      helpers: [],\n      stack,\n      violations: [],\n    };\n\n    currentViolationsMap = new Map();\n    currentUrls = new Set();\n    currentRouteNames = new Set();\n  }\n\n  if (context) {\n    currentUrls!.add(currentURL());\n    currentRouteNames!.add(_getCurrentRouteName());\n  }\n\n  axeResults.violations.forEach((violation) => {\n    const rule = currentViolationsMap!.get(violation.id);\n\n    if (rule === undefined) {\n      currentViolationsMap!.set(violation.id, violation);\n    } else {\n      rule.nodes.push(...violation.nodes);\n    }\n  });\n}\n\n/**\n * Invoked once per test. Accumulates the results into a set of results used for\n * reporting via the middleware reporter.\n */\nexport function pushTestResult() {\n  if (typeof currentTestResult !== 'undefined') {\n    currentTestResult.violations = [...currentViolationsMap!.values()];\n    currentTestResult.urls = [...currentUrls!.values()];\n    currentTestResult.routes = [...currentRouteNames!.values()];\n    currentTestResult.helpers = currentTestResult.testMetaData.usedHelpers;\n\n    TEST_SUITE_RESULTS.push(currentTestResult);\n\n    currentTestResult = undefined;\n    currentViolationsMap = undefined;\n    currentUrls = undefined;\n    currentRouteNames = undefined;\n  }\n}\n\ntype TestemCallback = (\n  config: unknown,\n  data: unknown,\n  callback: () => void,\n) => void;\n\ndeclare global {\n  interface Window {\n    Testem?: {\n      afterTests: (callback: TestemCallback) => void;\n    };\n  }\n}\n\n/**\n * Sets up the middleware reporter, which reports results when the test suite is done.\n */\nexport function setupMiddlewareReporter() {\n  setCustomReporter(middlewareReporter);\n\n  setEnableA11yAudit(true);\n\n  QUnit.testDone(pushTestResult);\n\n  if (window.Testem) {\n    window.Testem.afterTests(function (_config, _data, callback) {\n      void sendViolationsToServer().finally(callback);\n    });\n  } else {\n    QUnit.done(async function () {\n      await sendViolationsToServer();\n    });\n  }\n}\n\nasync function sendViolationsToServer() {\n  const response = await fetch('/report-violations', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(TEST_SUITE_RESULTS),\n  });\n  await response.json();\n}\n"],"names":["TEST_SUITE_RESULTS","currentTestResult","undefined","currentViolationsMap","currentUrls","currentRouteNames","_getCurrentRouteName","getFn","currentRouteName","routeName","error","Error","test","message","middlewareReporter","axeResults","violations","length","context","getContext","module","testName","QUnit","config","current","testMetaData","getTestMetadata","stack","macroCondition","isDevelopingApp","moduleName","name","urls","routes","helpers","Map","Set","add","currentURL","forEach","violation","rule","get","id","set","nodes","push","pushTestResult","values","usedHelpers","setupMiddlewareReporter","setCustomReporter","setEnableA11yAudit","testDone","window","Testem","afterTests","_config","_data","callback","sendViolationsToServer","finally","done","response","fetch","method","headers","body","JSON","stringify","json"],"mappings":"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"}